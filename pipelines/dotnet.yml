trigger:
  batch: true
  branches:
    include:
    - main
  paths:
    include:
    - dotnet
    - pipelines/dotnet.yml

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'
  package: 'dotnet/packages/Microsoft.TeamsAI/Microsoft.TeamsAI/Microsoft.Teams.AI.csproj'
  folderPath: 'dotnet/packages/Microsoft.TeamsAI/Microsoft.TeamsAI'

steps:
- task: UseDotNet@2
  inputs:
    version: '8.x'
    includePreviewVersions: true

- task: DotNetCoreCLI@2
  displayName: 'Restore'
  inputs:
    command: restore
    projects: '$(package)'

- task: DotNetCoreCLI@2
  displayName: 'Build'
  inputs:
    command: build
    projects: '$(package)'
    arguments: '--configuration $(buildConfiguration)'

- task: EsrpCodeSigning@5
  displayName: "Sign Dll [Authenticode + Strong Name]"
  inputs:
    ConnectedServiceName: 'TeamsESRP-CP-464385-Pgp'
    AppRegistrationClientId: cdc5aeea-15c5-4db6-b079-fcadd2505dc2
    AppRegistrationTenantId: d91c83b4-bfc6-40d3-a591-e5b0598a2796
    AuthAKVName: esrp-teams
    AuthSignCertName: d91c83b4-bfc6-40d3-a591-e5b0598a2796
    EsrpClientId: d91c83b4-bfc6-40d3-a591-e5b0598a2796
    UseMSIAuthentication: true
    FolderPath: '$(folderPath)'
    Pattern: |
      Release/**/Microsoft*Teams*AI*.dll
    UseMinimatch: true
    signConfigType: 'inlineSignParams'
    inlineOperation: |
      [
            {
              "KeyCode": "CP-233863-SN",
              "OperationCode": "StrongNameSign",
              "Parameters": {},
              "ToolName": "sign",
              "ToolVersion": "1.0"
            },
            {
              "KeyCode": "CP-233863-SN",
              "OperationCode": "StrongNameVerify",
              "Parameters": {},
              "ToolName": "sign",
              "ToolVersion": "1.0"
            },
            {
              "KeyCode": "CP-230012",
              "OperationCode": "SigntoolSign",
              "Parameters": {
                "OpusName": "Microsoft",
                "OpusInfo": "http://www.microsoft.com",
                "FileDigest": "/fd \"SHA256\"",
                "PageHash": "/NPH",
                "TimeStamp": "/tr \"http://rfc3161.gtm.corp.microsoft.com/TSS/HttpTspServer\" /td sha256"
              },
              "ToolName": "sign",
              "ToolVersion": "1.0"
            },
            {
              "KeyCode": "CP-230012",
              "OperationCode": "SigntoolVerify",
              "Parameters": {},
              "ToolName": "sign",
              "ToolVersion": "1.0"
            }
          ]
    SessionTimeout: '60'
    MaxConcurrency: '50'
    MaxRetryAttempts: '5'

- task: DotNetCoreCLI@2
  displayName: 'Pack'
  inputs:
    command: pack
    packagesToPack: '$(package)'
    packDestination: '$(Build.ArtifactStagingDirectory)'
    includeSymbols: true

- task: EsrpCodeSigning@5
  displayName: 'Sign Nuget package'
  inputs:
    ConnectedServiceName: 'TeamsESRP-CP-464385-Pgp'
    AppRegistrationClientId: cdc5aeea-15c5-4db6-b079-fcadd2505dc2
    AppRegistrationTenantId: d91c83b4-bfc6-40d3-a591-e5b0598a2796
    AuthAKVName: esrp-teams
    AuthSignCertName: d91c83b4-bfc6-40d3-a591-e5b0598a2796
    FolderPath: '$(Build.ArtifactStagingDirectory)'
    Pattern: '*.nupkg,*.snupkg'
    UseMinimatch: true
    signConfigType: 'inlineSignParams'
    inlineOperation: |
      [
          {
              "keyCode": "CP-401405",
              "operationSetCode": "NuGetSign",
              "parameters": [],
              "toolName": "sign",
              "toolVersion": "1.0"
          },
          {
              "keyCode": "CP-401405",
              "operationSetCode": "NuGetVerify",
              "parameters": [],
              "toolName": "sign",
              "toolVersion": "1.0"
          }
      ]
    SessionTimeout: '20'
    MaxConcurrency: '50'
    MaxRetryAttempts: '5'
    PendingAnalysisWaitTimeoutMinutes: '5'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact'
  inputs:
    PathToPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: Packages

- task: NuGetAuthenticate@1
  displayName: 'Azure NuGet Authenticate'

- task: NuGetCommand@2
  displayName: 'Azure NuGet Push'
  inputs:
    command: push
    publishVstsFeed: 'Github_Pipelines/Teams'
    allowPackageConflicts: true
    includeNugetOrg: true
